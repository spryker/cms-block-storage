<?xml version="1.0" encoding="utf-8"?>
<statemachine
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="process.xsd">

    <process name="RatepayElv01" main="true">
        <subprocesses>
            <process>RatepayShipment</process>
            <process>RatepayRefund</process>
            <process>RatepayCancel</process>
        </subprocesses>

        <states>
            <state name="new" reserved="true"/>
            <state name="payment confirmed"/>
            <state name="ready for refund" />
            <state name="refund succeeded" />
            <state name="completed" />

            <state name="ready for shipment"/>
            <state name="shipped"/>

            <state name="ready for cancel" />
            <state name="cancelled" />

            <state name="confirm payment invalid" />
            <state name="cancel invalid" />
            <state name="delivery invalid" />
            <state name="refund invalid" />
        </states>

        <transitions>
            <transition happy="true" condition="Ratepay/IsPaymentConfirmed">
                <source>new</source>
                <target>payment confirmed</target>
                <event>create payment confirmation</event>
            </transition>

            <transition>
                <source>new</source>
                <target>confirm payment invalid</target>
                <event>create payment confirmation</event>
            </transition>

            <transition happy="true">
                <source>payment confirmed</source>
                <target>ready for shipment</target>
                <event>ready for shipment</event>
            </transition>

            <transition happy="true" condition="Ratepay/IsDeliveryConfirmed">
                <source>shipped</source>
                <target>ready for refund</target>
                <event>create delivery confirmation</event>
            </transition>

            <transition>
                <source>shipped</source>
                <target>delivery invalid</target>
                <event>create delivery confirmation</event>
            </transition>
        </transitions>

        <events>
            <event name="create payment confirmation" onEnter="true" command="Ratepay/ConfirmPayment" />
            <event name="create delivery confirmation" onEnter="true" command="Ratepay/ConfirmDelivery" />
            <event name="ready for shipment" onEnter="true" />
            <event name="item not returned" timeout="90days" />
            <event name="item returned" onEnter="true" />
            <event name="return" manual="true" />
        </events>
    </process>

    <process name="RatepayShipment" file="RatepaySubProcesses/RatepayShipment.xml"/>
    <process name="RatepayRefund" file="RatepaySubProcesses/RatepayRefund.xml"/>
    <process name="RatepayCancel" file="RatepaySubProcesses/RatepayCancel.xml"/>
</statemachine>
